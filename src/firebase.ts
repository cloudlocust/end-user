import { initializeApp } from 'firebase/app'
import { getMessaging, getToken } from 'firebase/messaging'
import { axios } from 'src/common/react-platform-components'
import { REACT_APP_FIREBASE_VAPID_KEY, FIREBASE_CONFIG } from 'src/configs'
import { AUTH_BASE_URL } from './modules/User/configs'

// Initialize Firebase
const firebaseApp = initializeApp(FIREBASE_CONFIG)
//Access Firebase cloud messaging
const messaging = getMessaging(firebaseApp)

/**
 * This function allows us to get your device token from Firebase, which is required for sending Push notifications to your device.
 *
 * @param _onPermissionGranted Callback possibily send the token to backend, when token is generated by firebase.
 * @returns  Get Token From firebase.
 */
export const getTokenFromFirebase = (_onPermissionGranted?: () => void) => {
    return getToken(messaging, {
        vapidKey: REACT_APP_FIREBASE_VAPID_KEY,
    }).then(async (currentToken) => {
        if (currentToken)
            // eslint-disable-next-line jsdoc/require-jsdoc
            await axios.post<{
                /**
                 * Firebase device token.
                 */
                deviceToken: string
            }>(`${AUTH_BASE_URL}/add-subscriber-device-token`, { deviceToken: currentToken })
    })
}
